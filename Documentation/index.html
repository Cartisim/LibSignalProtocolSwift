<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SignalProtocolSwift  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="SignalProtocolSwift  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">SignalProtocolSwift Docs</a> (100% documented)</p>
        <p class="header-right"><a href="https://github.com/christophhagen/SignalProtocolSwift"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">SignalProtocolSwift Reference</a>
        <img id="carat" src="img/carat.png" />
        SignalProtocolSwift  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ReceiverChain.html">ReceiverChain</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SenderKeyRecord.html">SenderKeyRecord</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SenderKeyState.html">SenderKeyState</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SessionRecord.html">SessionRecord</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SessionState.html">SessionState</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SignalError.html">SignalError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/CipherTextType.html">CipherTextType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/HKDFVersion.html">HKDFVersion</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SignalEncryptionScheme.html">SignalEncryptionScheme</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SignalErrorType.html">SignalErrorType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Functions.html#/s:19SignalProtocolSwift14getFingerprint33_D0BC3BD30CB8A0CCC1BF762982B2C150LL10Foundation4DataVAF8identity_SS16stableIdentifierSi10iterationstKF">getFingerprint(identity:stableIdentifier:iterations:)</a>
              </li>
              <li class="nav-group-task">
                <a href="Functions.html#/s:19SignalProtocolSwift13getLogicalKey33_D0BC3BD30CB8A0CCC1BF762982B2C150LL10Foundation4DataVSayAA06PublicF0VG3for_tF">getLogicalKey(for:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/IdentityKeyStoreDelegate.html">IdentityKeyStoreDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/PreKeyStoreDelegate.html">PreKeyStoreDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SenderKeyStoreDelegate.html">SenderKeyStoreDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SessionStoreDelegate.html">SessionStoreDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SignalCryptoProvider.html">SignalCryptoProvider</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SignalProtocolStoreContext.html">SignalProtocolStoreContext</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SignedPreKeyStoreDelegate.html">SignedPreKeyStoreDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/CipherTextMessage.html">CipherTextMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DeviceConsistencyCommitmentV0.html">DeviceConsistencyCommitmentV0</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DeviceConsistencyMessage.html">DeviceConsistencyMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DeviceConsistencySignature.html">DeviceConsistencySignature</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DisplayableFingerprint.html">DisplayableFingerprint</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Fingerprint.html">Fingerprint</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GroupCipher.html">GroupCipher</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/HKDF.html">HKDF</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/KeyPair.html">KeyPair</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PendingPreKey.html">PendingPreKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PreKeySignalMessage.html">PreKeySignalMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PrivateKey.html">PrivateKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/PublicKey.html">PublicKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RatchetChainKey.html">RatchetChainKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RatchetMessageKeys.html">RatchetMessageKeys</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RatchetRootKey.html">RatchetRootKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ScannableFingerprint.html">ScannableFingerprint</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SenderChain.html">SenderChain</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SenderChainKey.html">SenderChainKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SenderKeyDistributionMessage.html">SenderKeyDistributionMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SenderKeyMessage.html">SenderKeyMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SenderMessageKey.html">SenderMessageKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionBuilder.html">SessionBuilder</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionCipher.html">SessionCipher</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionPreKey.html">SessionPreKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionPreKeyBundle.html">SessionPreKeyBundle</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionPreKeyPublic.html">SessionPreKeyPublic</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionSignedPreKey.html">SessionSignedPreKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SessionSignedPreKeyPublic.html">SessionSignedPreKeyPublic</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignalAddress.html">SignalAddress</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignalCommonCrypto.html">SignalCommonCrypto</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignalCrypto.html">SignalCrypto</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignalMessage.html">SignalMessage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SignalSenderKeyName.html">SignalSenderKeyName</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SymmetricParameters.html">SymmetricParameters</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Typealiases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:19SignalProtocolSwift22RatchetIdentityKeyPaira">RatchetIdentityKeyPair</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='signalprotocolswift' class='heading'>SignalProtocolSwift</h1>

<p>A Swift implementation of the Signal Protocol. The <a href="https://en.wikipedia.org/wiki/Signal_Protocol">Signal Protocol</a>
can be used for secure, end-to-end encrypted messaging in synchronous and asynchronous environments. It has
many desirable cryptographic features and can handle missing and out-of-order messages. The Signal protocol
is used by the <a href="signal.org">Signal Messenger</a> as well as WhatsApp, Facebook, Skype and others. Additional
information can be found <a href="https://signal.org/docs/">here</a>.</p>
<h2 id='purpose' class='heading'>Purpose</h2>

<p>This Swift library is intended for educational purposes only, in order to show the way the Signal Protocol works.
It mimics the functionality and structure of the <a href="https://github.com/signalapp/libsignal-protocol-c">Signal Protocol C implementation</a>.</p>
<h2 id='installation' class='heading'>Installation</h2>

<p>You can install <code>SignalProtocolSwift</code> through <a href="https://cocoapods.org">Cocoapods</a>, by adding the following to your <code>Podfile</code>:</p>
<pre class="highlight ruby"><code><span class="n">pod</span> <span class="s1">'SignalProtocolSwift'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s1">'https://github.com/christophhagen/SignalProtocolSwift'</span>
</code></pre>

<p><a href="https://github.com/christophhagen/Curve25519">Curve25519</a> is my framework to use the elliptic curve functions in Swift.</p>
<h2 id='prerequisites' class='heading'>Prerequisites</h2>
<h3 id='local-storage' class='heading'>Local storage</h3>

<p>The Signal Protocol needs local storage for message keys, identities and other state information. You can provide this functionality by implementing the protocol <code>SignalProtocolStoreContext</code>, which requires five delegates for the individual data stores:</p>

<ul>
<li><code>IdentityKeyStoreDelegate</code> for storing and retrieving identity keys</li>
<li><code>PreKeyStoreDelegate</code> for storing and retrieving pre keys</li>
<li><code>SenderKeyStoreDelegate</code> for storing and retrieving sender keys</li>
<li><code>SessionStoreDelegate</code> for storing and retrieving the sessions</li>
<li><code>SignedPreKeyStoreDelegate</code> for storing and retrieving signed pre keys</li>
</ul>

<p>You can have a look at the <a href="https://github.com/christophhagen/SignalProtocolSwift/tree/master/SignalProtocolSwiftTests/Test%20Implementation">test implementation</a> for inspiration.</p>
<h3 id='server-for-message-delivery' class='heading'>Server for message delivery</h3>

<p>The server that stores the messages for retrieval needs to store the following data for each <code>SignalAddress</code>:</p>

<ul>
<li><code>Public Identity Key Data</code>: The public part of the identity key of the device</li>
<li><code>Signed Pre Key Data</code>: The current signed pre key</li>
<li><code>Pre Keys</code>: A number of unsigned pre keys</li>
<li><code>Messages</code>: The messages to deliver</li>
</ul>
<h2 id='usage' class='heading'>Usage</h2>

<p>The standard process to establish an encrypted session between two devices (two distinct <code>SignalAddress</code>es) is usually as follows:</p>

<ul>
<li>Alice uploads her <code>Identity</code> (<code>PublicKey</code>, <code>deviceId</code> and <code>registrationId</code>) and a <code>SignedPreKey</code> to the server, as well as a number of unsigned <code>PreKey</code>s.</li>
<li>Bob retrieves a <code>PreKeyBundle</code> from the server, consisting of Alice&rsquo;s <code>Identity</code>, the <code>SignedPreKey</code>, and one of the <code>PreKey</code>s (which is then deleted from the server).</li>
<li>Bob creates a session by processing the <code>PreKeyBundle</code> and encrypting a <code>PreKeyMessage</code> which he uploads to the server.</li>
<li>Alice receives Bob&rsquo;s <code>PreKeyMessage</code> from the server and decryptes the message.</li>
<li>The encrypted session is established for both Alice and Bob.</li>
</ul>
<h3 id='creating-identity-and-keys' class='heading'>Creating identity and keys</h3>

<p>Before any secure communication can happen, at least one user needs to upload all necessary ingredients for a <code>PreKeyBundle</code> to the server.</p>
<pre class="highlight swift"><code><span class="c1">// Create the identity key and store it (only done once)</span>
<span class="k">let</span> <span class="nv">identity</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bobStore</span><span class="o">.</span><span class="nf">createIdentityKey</span><span class="p">()</span>

<span class="c1">// Create pre keys and save them in the store</span>
<span class="k">let</span> <span class="nv">preKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">Data</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bobStore</span><span class="o">.</span><span class="nf">createPreKeys</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1">// Create a signed pre key and save it in the store</span>
<span class="k">let</span> <span class="nv">signedPreKey</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="k">try</span> <span class="n">bobStore</span><span class="o">.</span><span class="nf">createSignedPrekey</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">// Upload identity, preKeys, and signedPreKey to the server</span>
</code></pre>
<h3 id='creating-a-session-from-a-prekeybundle' class='heading'>Creating a session from a PreKeyBundle</h3>

<p>Let&rsquo;s assume that Alice (who has the <code>SignalAddress</code> aliceAddress) wants to establish a session with Bob (<code>SignalAddress</code> bobAddress)</p>
<pre class="highlight swift"><code><span class="c1">// Download Bob's identity, current signedPreKey and one of the preKeys from the server</span>

<span class="c1">// Create PreKeyBundle</span>
<span class="k">let</span> <span class="nv">preKeyBundle</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">SessionPreKeyBundle</span><span class="p">(</span>
    <span class="nv">registrationId</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// Not used</span>
    <span class="nv">deviceId</span><span class="p">:</span> <span class="n">bobAddress</span><span class="o">.</span><span class="n">deviceId</span><span class="p">,</span>
    <span class="nv">preKey</span><span class="p">:</span> <span class="n">preKey</span><span class="p">,</span>
    <span class="nv">signedPreKey</span><span class="p">:</span> <span class="n">signedPreKey</span><span class="p">,</span>
    <span class="nv">identityKey</span><span class="p">:</span> <span class="n">identity</span><span class="p">)</span>

<span class="c1">// Create a new session by processing the PreKeyBundle</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">SessionCipher</span><span class="p">(</span><span class="nv">store</span><span class="p">:</span> <span class="n">aliceStore</span><span class="p">,</span> <span class="nv">remoteAddress</span><span class="p">:</span> <span class="n">bobAddress</span><span class="p">)</span>
<span class="k">try</span> <span class="n">session</span><span class="o">.</span><span class="nf">process</span><span class="p">(</span><span class="nv">preKeyBundle</span><span class="p">:</span> <span class="n">preKeyBundle</span><span class="p">)</span>

<span class="c1">// The message to encrypt</span>
<span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="s">"Hello Bob, it's Alice"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Here Alice can send messages to Bob</span>
<span class="k">let</span> <span class="nv">encryptedMessage</span> <span class="o">=</span> <span class="k">try</span> <span class="n">session</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="c1">// Upload the message to the server</span>
</code></pre>
<h3 id='creating-a-session-from-a-received-prekeysignalmessage' class='heading'>Creating a session from a received PreKeySignalMessage</h3>

<p>Let&rsquo;s continue the above example and assume Bob receives the message from Alice. Bob can then establish the session:</p>
<pre class="highlight swift"><code><span class="c1">// Get the message from the server</span>

<span class="c1">// Create the session</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">Session</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">aliceAddress</span><span class="p">)</span>

<span class="c1">// Process the message</span>
<span class="k">let</span> <span class="nv">decryptedMessage</span> <span class="o">=</span> <span class="k">try</span> <span class="n">session</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">preKeyMessage</span><span class="p">)</span>
</code></pre>
<h3 id='using-an-already-established-session' class='heading'>Using an already established session</h3>

<p>Now Alice and Bob can both send and receive messages at will.</p>
<h4 id='sending' class='heading'>Sending</h4>
<pre class="highlight swift"><code><span class="c1">// Compose a message</span>
<span class="k">let</span> <span class="nv">message</span> <span class="o">=</span>  <span class="s">"Hello there"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Encrypt</span>
<span class="k">let</span> <span class="nv">encryptedMessage</span> <span class="o">=</span> <span class="k">try</span> <span class="n">session</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre>
<h4 id='receiving' class='heading'>Receiving</h4>
<pre class="highlight swift"><code><span class="c1">// Get message from the server</span>

<span class="c1">// Decrypt</span>
<span class="k">let</span> <span class="nv">decryptedMessage</span> <span class="o">=</span> <span class="k">try</span> <span class="n">session</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre>
<h3 id='miscellaneous' class='heading'>Miscellaneous</h3>
<h4 id='provide-custom-crypto-implementation' class='heading'>Provide custom crypto implementation</h4>

<p>It is possible for any custom implementation of the <code>SignalCryptoProvider</code> protocol
to serve as the cryptographic backbone of the protocol. This can be done by
setting the static <code>provider</code> variable of the <code>SignalCrypto</code> class.</p>
<h4 id='documentation' class='heading'>Documentation</h4>

<p>The project is documented heavily because it helps other people understand the code. The <a href="https://github.com/christophhagen/SignalProtocolSwift/tree/master/Documentation">documentation</a>
is created with <a href="https://github.com/realm/jazzy">jazzy</a>, which creates awesome, apple-like
docs.</p>

<p>The docs can be (re-)generated by running the following in the project directory:</p>
<pre class="highlight plaintext"><code>jazzy --min-acl private -a 'Christoph Hagen' -u 'https://github.com/christophhagen' -g 'https://github.com/christophhagen/SignalProtocolSwift' -o 'Documentation'
</code></pre>
<h4 id='disclaimer' class='heading'>Disclaimer</h4>

<p>This code is NOT intended for production use! The code is neither reviewed for errors
nor written by an expert. Please do not implement your own cryptographic software,
if you don&rsquo;t know EXACTLY what you are doing.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2018 <a class="link" href="https://github.com/christophhagen" target="_blank" rel="external">Christoph Hagen</a>. All rights reserved. (Last updated: 2018-01-29)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.8.3</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
